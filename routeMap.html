<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Ö–æ–¥–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            padding: 12px 16px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #999);
            margin-top: 4px;
        }
        
        #map {
            flex: 1;
            width: 100%;
        }
        
        .controls {
            padding: 12px 16px;
            background: var(--tg-theme-bg-color, #fff);
            border-top: 1px solid var(--tg-theme-hint-color, #ccc);
            display: flex;
            gap: 10px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .btn:active {
            opacity: 0.7;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000);
        }
        
        .btn-primary {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
        }
        
        .btn-danger {
            background: #ff3b30;
            color: #fff;
        }
        
        .points-info {
            padding: 8px 16px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .points-count {
            font-weight: 600;
        }
        
        .distance {
            color: var(--tg-theme-hint-color, #999);
        }
        
        .debug-info {
            font-size: 11px;
            color: var(--tg-theme-hint-color, #999);
        }
        
        .view-mode .controls {
            justify-content: center;
        }
        
        .view-mode .btn {
            flex: none;
            width: auto;
            padding: 12px 32px;
        }
        
        .marker-number {
            background: var(--tg-theme-button-color, #3390ec);
            color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .point-popup {
            text-align: center;
        }
        
        .point-popup .point-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .point-popup .point-coords {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .point-popup .btn-remove {
            background: #ff3b30;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="headerTitle">–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h1>
        <p id="headerHint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –º–∞—Ä—à—Ä—É—Ç–∞</p>
    </div>
    
    <div id="map"></div>
    
    <div class="points-info">
        <span class="points-count" id="pointsCount">–¢–æ—á–µ–∫: 0</span>
        <span class="distance" id="distance"></span>
        <span class="debug-info" id="debugInfo"></span>
    </div>
    
    <div class="controls" id="controls">
        <button class="btn btn-danger" onclick="clearPoints()" id="clearBtn" disabled>üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn btn-primary" onclick="saveRoute()" id="saveBtn" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // –ü–∞—Ä—Å–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode') || 'create';
        const hikeId = params.get('hike_id');
        const routeData = params.get('route');
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        console.log('=== WebApp Init ===');
        console.log('Mode:', mode);
        console.log('Hike ID:', hikeId);
        console.log('Route data:', routeData);
        console.log('Full URL:', window.location.href);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º hike_id –≤ debug info
        document.getElementById('debugInfo').textContent = 'ID: ' + (hikeId || '–Ω–µ –∑–∞–¥–∞–Ω');
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let points = [];
        let markers = [];
        let polyline = null;
        let isViewMode = mode === 'view';
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        if (isViewMode) {
            document.body.classList.add('view-mode');
            document.getElementById('headerTitle').textContent = '–ü—Ä–æ—Å–º–æ—Ç—Ä –º–∞—Ä—à—Ä—É—Ç–∞';
            document.getElementById('headerHint').textContent = '–ú–∞—Ä—à—Ä—É—Ç –≤–∞—à–µ–≥–æ –ø–æ—Ö–æ–¥–∞';
            document.getElementById('controls').innerHTML = 
                '<button class="btn btn-secondary" onclick="tg.close()">–ó–∞–∫—Ä—ã—Ç—å</button>';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map', {
            zoomControl: true,
            attributionControl: false
        }).setView([55.7558, 37.6173], 10);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);
        
        // –ö–∞—Å—Ç–æ–º–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –º–∞—Ä–∫–µ—Ä–∞
        function createNumberedIcon(number) {
            return L.divIcon({
                className: 'custom-marker',
                html: '<div class="marker-number">' + number + '</div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        if (routeData) {
            try {
                console.log('Parsing route data...');
                const decoded = decodeURIComponent(routeData);
                console.log('Decoded:', decoded);
                const route = JSON.parse(decoded);
                console.log('Parsed route:', route);
                
                if (route.points && Array.isArray(route.points)) {
                    route.points.forEach(function(p, idx) {
                        const lat = p.lat || p.Latitude;
                        const lng = p.lng || p.lon || p.Longitude;
                        const name = p.name || p.Name || ('–¢–æ—á–∫–∞ ' + (idx + 1));
                        console.log('Adding point:', lat, lng, name);
                        addPointInternal(lat, lng, name, !isViewMode);
                    });
                    fitMapToPoints();
                }
            } catch (e) {
                console.error('Error parsing route data:', e);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
        if (!isViewMode) {
            map.on('click', function(e) {
                console.log('Map clicked:', e.latlng);
                addPoint(e.latlng.lat, e.latlng.lng);
            });
        }
        
        function addPoint(lat, lng) {
            const name = '–¢–æ—á–∫–∞ ' + (points.length + 1);
            addPointInternal(lat, lng, name, true);
        }
        
        function addPointInternal(lat, lng, name, canRemove) {
            const point = { 
                lat: parseFloat(lat.toFixed(6)), 
                lng: parseFloat(lng.toFixed(6)), 
                name: name 
            };
            points.push(point);
            
            const marker = L.marker([lat, lng], {
                icon: createNumberedIcon(points.length)
            }).addTo(map);
            
            let popupContent = '<div class="point-popup">' +
                '<div class="point-name">' + name + '</div>' +
                '<div class="point-coords">' + lat.toFixed(4) + ', ' + lng.toFixed(4) + '</div>';
            
            if (canRemove && !isViewMode) {
                const pointIndex = points.length - 1;
                popupContent += '<button class="btn-remove" onclick="removePoint(' + pointIndex + ')">–£–¥–∞–ª–∏—Ç—å</button>';
            }
            
            popupContent += '</div>';
            marker.bindPopup(popupContent);
            
            markers.push(marker);
            updatePolyline();
            updateInfo();
            
            console.log('Point added:', point, 'Total:', points.length);
        }
        
        function removePoint(index) {
            if (index < 0 || index >= points.length) return;
            
            console.log('Removing point:', index);
            
            points.splice(index, 1);
            markers.forEach(function(m) { map.removeLayer(m); });
            markers = [];
            
            const pointsCopy = points.slice();
            points = [];
            
            pointsCopy.forEach(function(p, idx) {
                addPointInternal(p.lat, p.lng, '–¢–æ—á–∫–∞ ' + (idx + 1), true);
            });
            
            map.closePopup();
        }
        
        function updatePolyline() {
            if (polyline) {
                map.removeLayer(polyline);
            }
            
            if (points.length >= 2) {
                polyline = L.polyline(
                    points.map(function(p) { return [p.lat, p.lng]; }), 
                    {
                        color: tg.themeParams.button_color || '#3390ec',
                        weight: 4,
                        opacity: 0.8
                    }
                ).addTo(map);
            }
        }
        
        function calculateDistance() {
            if (points.length < 2) return 0;
            
            let total = 0;
            for (let i = 0; i < points.length - 1; i++) {
                total += haversineDistance(
                    points[i].lat, points[i].lng,
                    points[i+1].lat, points[i+1].lng
                );
            }
            return total;
        }
        
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function updateInfo() {
            document.getElementById('pointsCount').textContent = '–¢–æ—á–µ–∫: ' + points.length;
            
            const dist = calculateDistance();
            if (dist > 0) {
                document.getElementById('distance').textContent = '‚âà ' + dist.toFixed(2) + ' –∫–º';
            } else {
                document.getElementById('distance').textContent = '';
            }
            
            const saveBtn = document.getElementById('saveBtn');
            const clearBtn = document.getElementById('clearBtn');
            
            if (saveBtn) {
                saveBtn.disabled = points.length < 2;
            }
            if (clearBtn) {
                clearBtn.disabled = points.length === 0;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º MainButton
            if (!isViewMode) {
                if (points.length >= 2) {
                    tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç (' + points.length + ' —Ç–æ—á–µ–∫)');
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
            }
        }
        
        function fitMapToPoints() {
            if (points.length === 0) return;
            
            if (points.length === 1) {
                map.setView([points[0].lat, points[0].lng], 14);
            } else {
                const bounds = L.latLngBounds(points.map(function(p) { return [p.lat, p.lng]; }));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        function clearPoints() {
            if (points.length === 0) return;
            
            tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞?', function(confirmed) {
                if (confirmed) {
                    console.log('Clearing all points');
                    points = [];
                    markers.forEach(function(m) { map.removeLayer(m); });
                    markers = [];
                    if (polyline) {
                        map.removeLayer(polyline);
                        polyline = null;
                    }
                    updateInfo();
                }
            });
        }
        
        function saveRoute() {
            console.log('=== saveRoute called ===');
            
            if (points.length < 2) {
                tg.showAlert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º hike_id
            const hikeIdInt = parseInt(hikeId);
            console.log('hike_id raw:', hikeId);
            console.log('hike_id parsed:', hikeIdInt);
            
            if (!hikeIdInt || hikeIdInt <= 0) {
                console.error('Invalid hike_id!');
                tg.showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –ø–æ—Ö–æ–¥–∞ (hike_id=' + hikeId + ')');
                return;
            }
            
            const routeData = {
                action: 'save_route',
                hike_id: hikeIdInt,
                points: points,
                distance: calculateDistance()
            };
            
            console.log('Route data to send:', routeData);
            
            try {
                const jsonData = JSON.stringify(routeData);
                console.log('JSON string:', jsonData);
                console.log('JSON length:', jsonData.length);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω
                if (!tg || !tg.sendData) {
                    console.error('Telegram WebApp not available!');
                    tg.showAlert('–û—à–∏–±–∫–∞: Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                    return;
                }
                
                console.log('Calling tg.sendData()...');
                tg.sendData(jsonData);
                console.log('tg.sendData() called successfully');
                
            } catch (e) {
                console.error('Error in saveRoute:', e);
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message);
            }
        }
        
        // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
        if (navigator.geolocation && !routeData) {
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    console.log('Geolocation:', pos.coords);
                    map.setView([pos.coords.latitude, pos.coords.longitude], 12);
                },
                function(err) {
                    console.log('Geolocation error:', err);
                },
                { enableHighAccuracy: true, timeout: 5000 }
            );
        }
        
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" Telegram
        tg.BackButton.show();
        tg.BackButton.onClick(function() {
            if (!isViewMode && points.length > 0) {
                tg.showConfirm('–í—ã–π—Ç–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è?', function(confirmed) {
                    if (confirmed) {
                        tg.close();
                    }
                });
            } else {
                tg.close();
            }
        });
        
        // Main Button –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        if (!isViewMode) {
            tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç');
            tg.MainButton.onClick(saveRoute);
        }
        
        updateInfo();
        
        console.log('=== WebApp Ready ===');
    </script>
</body>
</html>
