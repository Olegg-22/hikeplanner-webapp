<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Ö–æ–¥–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 12px 16px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
        }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header p { font-size: 13px; color: var(--tg-theme-hint-color, #999); margin-top: 4px; }
        #map { flex: 1; width: 100%; }
        .controls {
            padding: 12px 16px;
            background: var(--tg-theme-bg-color, #fff);
            border-top: 1px solid var(--tg-theme-hint-color, #ccc);
            display: flex;
            gap: 10px;
        }
        .btn {
            flex: 1; padding: 12px 16px; border: none; border-radius: 10px;
            font-size: 15px; font-weight: 500; cursor: pointer;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--tg-theme-secondary-bg-color, #f0f0f0); color: var(--tg-theme-text-color, #000); }
        .btn-primary { background: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); }
        .btn-danger { background: #ff3b30; color: #fff; }
        .points-info {
            padding: 8px 16px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }
        .status-bar {
            padding: 6px 16px;
            font-size: 11px;
            font-family: monospace;
            background: #fffbe6;
            border-bottom: 1px solid #ffd666;
            display: none;
        }
        .status-bar.show { display: block; }
        .status-bar.error { background: #fff2f0; border-color: #ff4d4f; color: #a8071a; }
        .status-bar.success { background: #f6ffed; border-color: #52c41a; color: #135200; }
        .marker-number {
            background: var(--tg-theme-button-color, #3390ec);
            color: #fff; border-radius: 50%;
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 600;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .loading {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center;
            z-index: 10000;
        }
        .loading.show { display: flex; }
        .loading-content {
            background: white; padding: 24px 32px; border-radius: 12px;
            text-align: center;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar"></div>
    
    <div class="header">
        <h1 id="headerTitle">–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h1>
        <p id="headerHint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</p>
    </div>

    <div id="map"></div>

    <div class="points-info">
        <span id="pointsCount">–¢–æ—á–µ–∫: 0</span>
        <span id="distance"></span>
    </div>

    <div class="controls" id="controls">
        <button class="btn btn-danger" onclick="clearPoints()" id="clearBtn" disabled>üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn btn-primary" onclick="saveRoute()" id="saveBtn" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="spinner"></div>
            <div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); }

        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode') || 'create';
        const hikeId = params.get('hike_id');
        const apiUrl = params.get('api_url');
        const routeDataParam = params.get('route');

        let points = [];
        let markers = [];
        let polyline = null;
        const isViewMode = mode === 'view';

        function showStatus(msg, type = '') {
            const bar = document.getElementById('statusBar');
            bar.textContent = msg;
            bar.className = 'status-bar show ' + type;
            console.log('[Status]', msg);
        }

        function showLoading(show) {
            document.getElementById('loading').className = 'loading' + (show ? ' show' : '');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        showStatus('–ó–∞–≥—Ä—É–∑–∫–∞... mode=' + mode + ', hike_id=' + hikeId);

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        if (isViewMode) {
            document.getElementById('headerTitle').textContent = '–ü—Ä–æ—Å–º–æ—Ç—Ä –º–∞—Ä—à—Ä—É—Ç–∞';
            document.getElementById('headerHint').textContent = '–ú–∞—Ä—à—Ä—É—Ç –≤–∞—à–µ–≥–æ –ø–æ—Ö–æ–¥–∞';
            document.getElementById('controls').innerHTML = 
                '<button class="btn btn-secondary" onclick="closeApp()" style="flex:none;padding:12px 32px;">–ó–∞–∫—Ä—ã—Ç—å</button>';
        }

        // –ö–∞—Ä—Ç–∞
        const map = L.map('map', { zoomControl: true, attributionControl: false })
            .setView([55.7558, 37.6173], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        function createIcon(num) {
            return L.divIcon({
                className: 'custom-marker',
                html: '<div class="marker-number">' + num + '</div>',
                iconSize: [24, 24], iconAnchor: [12, 12]
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        if (routeDataParam) {
            showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –∏–∑ URL...');
            console.log('Raw route param:', routeDataParam);
            
            try {
                const decoded = decodeURIComponent(routeDataParam);
                console.log('Decoded:', decoded);
                
                const routeObj = JSON.parse(decoded);
                console.log('Parsed route object:', routeObj);
                
                // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
                let pointsArray = routeObj.points || routeObj.Points || routeObj;
                
                if (Array.isArray(pointsArray) && pointsArray.length > 0) {
                    console.log('Points array:', pointsArray);
                    
                    pointsArray.forEach((p, i) => {
                        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –ø–æ–ª–µ–π
                        const lat = p.lat || p.Lat || p.Latitude || p.latitude;
                        const lng = p.lng || p.Lng || p.lon || p.Lon || p.Longitude || p.longitude;
                        const name = p.name || p.Name || ('–¢–æ—á–∫–∞ ' + (i + 1));
                        
                        console.log('Point ' + i + ':', lat, lng, name);
                        
                        if (lat && lng) {
                            addPointInternal(parseFloat(lat), parseFloat(lng), name, !isViewMode);
                        }
                    });
                    
                    if (points.length > 0) {
                        fitMapToPoints();
                        showStatus('–ó–∞–≥—Ä—É–∂–µ–Ω–æ ' + points.length + ' —Ç–æ—á–µ–∫', 'success');
                    } else {
                        showStatus('–¢–æ—á–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö', 'error');
                    }
                } else {
                    showStatus('–ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ —Ç–æ—á–µ–∫', 'error');
                    console.log('Points array is empty or invalid');
                }
            } catch (e) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, 'error');
                console.error('Parse error:', e);
            }
        } else if (isViewMode) {
            showStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞', 'error');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        if (!isViewMode) {
            map.on('click', e => addPoint(e.latlng.lat, e.latlng.lng));
        }

        function addPoint(lat, lng) {
            addPointInternal(lat, lng, '–¢–æ—á–∫–∞ ' + (points.length + 1), true);
            showStatus('–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–æ—á–∫–∞ ' + points.length);
        }

        function addPointInternal(lat, lng, name, canRemove) {
            const point = { lat: +lat.toFixed(6), lng: +lng.toFixed(6), name: name };
            points.push(point);

            const marker = L.marker([lat, lng], { icon: createIcon(points.length) }).addTo(map);
            
            let popup = '<div style="text-align:center"><b>' + name + '</b><br>' +
                        '<small>' + lat.toFixed(4) + ', ' + lng.toFixed(4) + '</small>';
            if (canRemove && !isViewMode) {
                popup += '<br><button onclick="removePoint(' + (points.length-1) + ')" ' +
                        'style="margin-top:8px;background:#ff3b30;color:#fff;border:none;' +
                        'padding:4px 12px;border-radius:4px;cursor:pointer">–£–¥–∞–ª–∏—Ç—å</button>';
            }
            popup += '</div>';
            marker.bindPopup(popup);
            markers.push(marker);
            
            updatePolyline();
            updateInfo();
        }

        function removePoint(idx) {
            points.splice(idx, 1);
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const copy = [...points];
            points = [];
            copy.forEach((p, i) => addPointInternal(p.lat, p.lng, '–¢–æ—á–∫–∞ ' + (i+1), true));
            map.closePopup();
            showStatus('–¢–æ—á–∫–∞ —É–¥–∞–ª–µ–Ω–∞, –æ—Å—Ç–∞–ª–æ—Å—å: ' + points.length);
        }

        function updatePolyline() {
            if (polyline) map.removeLayer(polyline);
            if (points.length >= 2) {
                polyline = L.polyline(points.map(p => [p.lat, p.lng]), {
                    color: tg?.themeParams?.button_color || '#3390ec',
                    weight: 4, opacity: 0.8
                }).addTo(map);
            }
        }

        function calcDistance() {
            if (points.length < 2) return 0;
            let total = 0;
            for (let i = 0; i < points.length - 1; i++) {
                const R = 6371;
                const dLat = (points[i+1].lat - points[i].lat) * Math.PI / 180;
                const dLon = (points[i+1].lng - points[i].lng) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(points[i].lat*Math.PI/180) * 
                          Math.cos(points[i+1].lat*Math.PI/180) * Math.sin(dLon/2)**2;
                total += R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }
            return total;
        }

        function updateInfo() {
            document.getElementById('pointsCount').textContent = '–¢–æ—á–µ–∫: ' + points.length;
            const dist = calcDistance();
            document.getElementById('distance').textContent = dist > 0 ? '‚âà ' + dist.toFixed(2) + ' –∫–º' : '';
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º
            const saveBtn = document.getElementById('saveBtn');
            const clearBtn = document.getElementById('clearBtn');
            
            if (saveBtn) {
                saveBtn.disabled = points.length < 2;
            }
            if (clearBtn) {
                clearBtn.disabled = points.length === 0;
            }

            // MainButton —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            if (!isViewMode && tg?.MainButton) {
                if (points.length >= 2) {
                    tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å (' + points.length + ' —Ç–æ—á–µ–∫)');
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
            }
        }

        function fitMapToPoints() {
            if (!points.length) return;
            if (points.length === 1) {
                map.setView([points[0].lat, points[0].lng], 14);
            } else {
                const bounds = L.latLngBounds(points.map(p => [p.lat, p.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        function clearPoints() {
            const doIt = () => {
                points = [];
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                if (polyline) { map.removeLayer(polyline); polyline = null; }
                updateInfo();
                showStatus('–í—Å–µ —Ç–æ—á–∫–∏ —É–¥–∞–ª–µ–Ω—ã');
            };
            
            if (tg?.showConfirm) {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏?', ok => { if (ok) doIt(); });
            } else if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏?')) {
                doIt();
            }
        }

        function closeApp() {
            if (tg?.close) tg.close();
            else window.close();
        }

        // ============ –°–û–•–†–ê–ù–ï–ù–ò–ï ============
        async function saveRoute() {
            showStatus('–ù–∞—á–∏–Ω–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');

            if (points.length < 2) {
                showStatus('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏!', 'error');
                alert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏!');
                return;
            }

            const hikeIdInt = parseInt(hikeId);
            if (!hikeIdInt) {
                showStatus('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω hike_id', 'error');
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –ø–æ—Ö–æ–¥–∞');
                return;
            }

            if (!apiUrl) {
                showStatus('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω api_url', 'error');
                alert('–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
                return;
            }

            const data = {
                action: 'save_route',
                hike_id: hikeIdInt,
                user_id: tg?.initDataUnsafe?.user?.id || 0,
                points: points,
                distance: calcDistance()
            };

            showLoading(true);
            showStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ ' + apiUrl + '...');

            try {
                const response = await fetch(apiUrl + '/api/save-route', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                showLoading(false);

                if (response.ok && result.status === 'ok') {
                    showStatus('‚úÖ –ú–∞—Ä—à—Ä—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                    
                    setTimeout(() => {
                        if (tg?.showAlert) {
                            tg.showAlert('‚úÖ –ú–∞—Ä—à—Ä—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!\n\n' +
                                        'üìç –¢–æ—á–µ–∫: ' + points.length + '\n' +
                                        'üìè –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ' + calcDistance().toFixed(2) + ' –∫–º',
                                        () => closeApp());
                        } else {
                            alert('–ú–∞—Ä—à—Ä—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                            closeApp();
                        }
                    }, 300);
                } else {
                    showStatus('‚ùå –û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (result.message || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ'));
                }
            } catch (e) {
                showLoading(false);
                showStatus('‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + e.message, 'error');
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
            }
        }

        // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞)
        if (navigator.geolocation && !routeDataParam && !isViewMode) {
            navigator.geolocation.getCurrentPosition(
                pos => map.setView([pos.coords.latitude, pos.coords.longitude], 12),
                () => {}, { enableHighAccuracy: true, timeout: 5000 }
            );
        }

        // Telegram –∫–Ω–æ–ø–∫–∏
        if (tg?.BackButton) {
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                if (!isViewMode && points.length > 0) {
                    tg.showConfirm('–í—ã–π—Ç–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è?', ok => { if (ok) closeApp(); });
                } else {
                    closeApp();
                }
            });
        }

        if (tg?.MainButton && !isViewMode) {
            tg.MainButton.onClick(saveRoute);
        }

        updateInfo();
        
        if (!routeDataParam && !isViewMode) {
            showStatus('–ì–æ—Ç–æ–≤–æ. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫.', 'success');
        }
    </script>
</body>
</html>
