<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Ö–æ–¥–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 12px 16px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
        }
        .header h1 { font-size: 18px; font-weight: 600; }
        .header p { font-size: 13px; color: var(--tg-theme-hint-color, #999); margin-top: 4px; }
        #map { flex: 1; width: 100%; }
        .controls {
            padding: 12px 16px;
            background: var(--tg-theme-bg-color, #fff);
            border-top: 1px solid var(--tg-theme-hint-color, #ccc);
            display: flex;
            gap: 10px;
        }
        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--tg-theme-secondary-bg-color, #f0f0f0); color: var(--tg-theme-text-color, #000); }
        .btn-primary { background: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); }
        .btn-danger { background: #ff3b30; color: #fff; }
        .points-info {
            padding: 8px 16px;
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .debug-panel {
            padding: 8px 16px;
            background: #fffbe6;
            border-bottom: 1px solid #ffd666;
            font-size: 11px;
            font-family: monospace;
            max-height: 100px;
            overflow-y: auto;
        }
        .debug-panel.error { background: #fff2f0; border-color: #ff4d4f; }
        .debug-panel.success { background: #f6ffed; border-color: #52c41a; }
        .marker-number {
            background: var(--tg-theme-button-color, #3390ec);
            color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .point-popup { text-align: center; }
        .point-popup .point-name { font-weight: 600; margin-bottom: 4px; }
        .point-popup .point-coords { font-size: 12px; color: #666; margin-bottom: 8px; }
        .point-popup .btn-remove {
            background: #ff3b30; color: #fff; border: none;
            padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="debug-panel" id="debugPanel">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    
    <div class="header">
        <h1 id="headerTitle">–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞</h1>
        <p id="headerHint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É</p>
    </div>

    <div id="map"></div>

    <div class="points-info">
        <span id="pointsCount">–¢–æ—á–µ–∫: 0</span>
        <span id="distance"></span>
    </div>

    <div class="controls" id="controls">
        <button class="btn btn-danger" onclick="clearPoints()" id="clearBtn" disabled>üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
        <button class="btn btn-primary" onclick="saveRoute()" id="saveBtn" disabled>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <script>
        const debugPanel = document.getElementById('debugPanel');
        
        function debugLog(msg, isError = false, isSuccess = false) {
            console.log(msg);
            const time = new Date().toLocaleTimeString();
            debugPanel.innerHTML = `[${time}] ${msg}<br>` + debugPanel.innerHTML;
            debugPanel.className = 'debug-panel' + (isError ? ' error' : '') + (isSuccess ? ' success' : '');
        }

        // === –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê TELEGRAM WEBAPP ===
        debugLog('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã...');
        
        const tg = window.Telegram?.WebApp;
        
        if (!tg) {
            debugLog('‚ùå Telegram WebApp –ù–ï –î–û–°–¢–£–ü–ï–ù! –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram.', true);
        } else {
            debugLog('‚úì Telegram WebApp –∑–∞–≥—Ä—É–∂–µ–Ω');
            debugLog('Platform: ' + tg.platform);
            debugLog('Version: ' + tg.version);
            debugLog('initData length: ' + (tg.initData?.length || 0));
            debugLog('initDataUnsafe: ' + JSON.stringify(tg.initDataUnsafe?.user?.id || 'null'));
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ
            if (!tg.initData || tg.initData.length === 0) {
                debugLog('‚ö†Ô∏è initData –ø—É—Å—Ç–æ–π - sendData –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å!', true);
            }
            
            tg.ready();
            tg.expand();
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode') || 'create';
        const hikeId = params.get('hike_id');
        const routeDataParam = params.get('route');

        debugLog('Mode: ' + mode + ', HikeID: ' + hikeId);

        if (!hikeId || hikeId === 'null' || hikeId === '0') {
            debugLog('‚ùå hike_id –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL!', true);
        }

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let points = [];
        let markers = [];
        let polyline = null;
        let isViewMode = mode === 'view';

        if (isViewMode) {
            document.body.classList.add('view-mode');
            document.getElementById('headerTitle').textContent = '–ü—Ä–æ—Å–º–æ—Ç—Ä –º–∞—Ä—à—Ä—É—Ç–∞';
            document.getElementById('headerHint').textContent = '–ú–∞—Ä—à—Ä—É—Ç –≤–∞—à–µ–≥–æ –ø–æ—Ö–æ–¥–∞';
            document.getElementById('controls').innerHTML = 
                '<button class="btn btn-secondary" onclick="tg.close()">–ó–∞–∫—Ä—ã—Ç—å</button>';
        }

        // –ö–∞—Ä—Ç–∞
        const map = L.map('map', { zoomControl: true, attributionControl: false })
            .setView([55.7558, 37.6173], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

        function createNumberedIcon(number) {
            return L.divIcon({
                className: 'custom-marker',
                html: '<div class="marker-number">' + number + '</div>',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
        if (routeDataParam) {
            try {
                const decoded = decodeURIComponent(routeDataParam);
                const route = JSON.parse(decoded);
                if (route.points && Array.isArray(route.points)) {
                    route.points.forEach((p, idx) => {
                        const lat = p.lat || p.Latitude;
                        const lng = p.lng || p.lon || p.Longitude;
                        addPointInternal(lat, lng, p.name || '–¢–æ—á–∫–∞ ' + (idx + 1), !isViewMode);
                    });
                    fitMapToPoints();
                    debugLog('–ó–∞–≥—Ä—É–∂–µ–Ω–æ ' + points.length + ' —Ç–æ—á–µ–∫');
                }
            } catch (e) {
                debugLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞: ' + e.message, true);
            }
        }

        if (!isViewMode) {
            map.on('click', (e) => addPoint(e.latlng.lat, e.latlng.lng));
        }

        function addPoint(lat, lng) {
            addPointInternal(lat, lng, '–¢–æ—á–∫–∞ ' + (points.length + 1), true);
        }

        function addPointInternal(lat, lng, name, canRemove) {
            const point = { lat: +lat.toFixed(6), lng: +lng.toFixed(6), name };
            points.push(point);

            const marker = L.marker([lat, lng], { icon: createNumberedIcon(points.length) }).addTo(map);

            let popup = '<div class="point-popup"><div class="point-name">' + name + '</div>' +
                '<div class="point-coords">' + lat.toFixed(4) + ', ' + lng.toFixed(4) + '</div>';
            if (canRemove && !isViewMode) {
                popup += '<button class="btn-remove" onclick="removePoint(' + (points.length - 1) + ')">–£–¥–∞–ª–∏—Ç—å</button>';
            }
            popup += '</div>';
            marker.bindPopup(popup);
            markers.push(marker);
            updatePolyline();
            updateInfo();
        }

        function removePoint(index) {
            points.splice(index, 1);
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const copy = [...points];
            points = [];
            copy.forEach((p, i) => addPointInternal(p.lat, p.lng, '–¢–æ—á–∫–∞ ' + (i + 1), true));
            map.closePopup();
        }

        function updatePolyline() {
            if (polyline) map.removeLayer(polyline);
            if (points.length >= 2) {
                polyline = L.polyline(points.map(p => [p.lat, p.lng]), {
                    color: tg?.themeParams?.button_color || '#3390ec',
                    weight: 4, opacity: 0.8
                }).addTo(map);
            }
        }

        function calculateDistance() {
            if (points.length < 2) return 0;
            let total = 0;
            for (let i = 0; i < points.length - 1; i++) {
                const R = 6371;
                const dLat = (points[i+1].lat - points[i].lat) * Math.PI / 180;
                const dLon = (points[i+1].lng - points[i].lng) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(points[i].lat*Math.PI/180) * 
                          Math.cos(points[i+1].lat*Math.PI/180) * Math.sin(dLon/2)**2;
                total += R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }
            return total;
        }

        function updateInfo() {
            document.getElementById('pointsCount').textContent = '–¢–æ—á–µ–∫: ' + points.length;
            const dist = calculateDistance();
            document.getElementById('distance').textContent = dist > 0 ? '‚âà ' + dist.toFixed(2) + ' –∫–º' : '';
            
            const saveBtn = document.getElementById('saveBtn');
            const clearBtn = document.getElementById('clearBtn');
            if (saveBtn) saveBtn.disabled = points.length < 2;
            if (clearBtn) clearBtn.disabled = points.length === 0;

            if (!isViewMode && tg?.MainButton) {
                if (points.length >= 2) {
                    tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å (' + points.length + ' —Ç–æ—á–µ–∫)');
                    tg.MainButton.show();
                } else {
                    tg.MainButton.hide();
                }
            }
        }

        function fitMapToPoints() {
            if (points.length === 0) return;
            if (points.length === 1) {
                map.setView([points[0].lat, points[0].lng], 14);
            } else {
                map.fitBounds(L.latLngBounds(points.map(p => [p.lat, p.lng])), { padding: [50, 50] });
            }
        }

        function clearPoints() {
            if (tg?.showConfirm) {
                tg.showConfirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏?', (ok) => { if (ok) doClear(); });
            } else {
                if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ—á–∫–∏?')) doClear();
            }
        }

        function doClear() {
            points = [];
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            if (polyline) { map.removeLayer(polyline); polyline = null; }
            updateInfo();
            debugLog('–í—Å–µ —Ç–æ—á–∫–∏ —É–¥–∞–ª–µ–Ω—ã');
        }

        // === –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø ===
        function saveRoute() {
            debugLog('=== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ ===');

            if (points.length < 2) {
                debugLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫', true);
                if (tg?.showAlert) tg.showAlert('–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 —Ç–æ—á–∫–∏');
                return;
            }

            const hikeIdInt = parseInt(hikeId);
            if (!hikeIdInt || hikeIdInt <= 0) {
                debugLog('–û—à–∏–±–∫–∞: hike_id = ' + hikeId, true);
                if (tg?.showAlert) tg.showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID –ø–æ—Ö–æ–¥–∞');
                return;
            }

            const data = {
                action: 'save_route',
                hike_id: hikeIdInt,
                points: points,
                distance: calculateDistance()
            };

            debugLog('–î–∞–Ω–Ω—ã–µ: ' + JSON.stringify(data).substring(0, 100) + '...');

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å sendData
            if (!tg) {
                debugLog('‚ùå Telegram WebApp –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', true);
                alert('–û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram!');
                return;
            }

            if (!tg.sendData) {
                debugLog('‚ùå tg.sendData –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', true);
                alert('–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
                return;
            }

            if (!tg.initData || tg.initData.length === 0) {
                debugLog('‚ö†Ô∏è initData –ø—É—Å—Ç–æ–π - –æ—Ç–ø—Ä–∞–≤–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞—Ç—å', true);
            }

            try {
                const jsonData = JSON.stringify(data);
                debugLog('–û—Ç–ø—Ä–∞–≤–∫–∞ ' + jsonData.length + ' –±–∞–π—Ç...');
                
                // –í—ã–∑—ã–≤–∞–µ–º sendData
                tg.sendData(jsonData);
                
                debugLog('‚úì sendData –≤—ã–∑–≤–∞–Ω (–æ–∫–Ω–æ –¥–æ–ª–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å—Å—è)', true, true);
                
                // –ï—Å–ª–∏ –æ–∫–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫ - —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫
                setTimeout(() => {
                    debugLog('‚ö†Ô∏è –û–∫–Ω–æ –Ω–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å - –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã', true);
                }, 2000);
                
            } catch (e) {
                debugLog('‚ùå –û—à–∏–±–∫–∞: ' + e.message, true);
                if (tg?.showAlert) tg.showAlert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        // –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è
        if (navigator.geolocation && !routeDataParam) {
            navigator.geolocation.getCurrentPosition(
                (pos) => map.setView([pos.coords.latitude, pos.coords.longitude], 12),
                () => {},
                { enableHighAccuracy: true, timeout: 5000 }
            );
        }

        // –ö–Ω–æ–ø–∫–∏ Telegram
        if (tg?.BackButton) {
            tg.BackButton.show();
            tg.BackButton.onClick(() => {
                if (!isViewMode && points.length > 0) {
                    tg.showConfirm('–í—ã–π—Ç–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è?', (ok) => { if (ok) tg.close(); });
                } else {
                    tg.close();
                }
            });
        }

        if (tg?.MainButton && !isViewMode) {
            tg.MainButton.setText('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç');
            tg.MainButton.onClick(saveRoute);
        }

        updateInfo();
        debugLog('‚úì –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ');
    </script>
</body>
</html>
